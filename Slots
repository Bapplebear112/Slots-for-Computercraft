-------------------------
-- SLOT MACHINE SETTINGS
-------------------------
local SYMBOLS = {"I","B","E","D","G","N"} 
local SYMBOL_COLORS = {I=colors.red, B=colors.orange, E=colors.yellow, D=colors.green, G=colors.blue, N=colors.purple} -- symbol colors

local BASE_SPIN_TIME = 1.5        -- total spin duration for first column
local SPIN_STAGGER = 0.3          -- extra spin time per next column
local JACKPOT_CAP = 128
local PAYOUTS = {I=2,B=3,E=4,D=5,G=6}
local PITY_PAYOUTS = {I=0,B=0,E=0,D=0,G=0,N=1}

local MONITOR_BG = colors.cyan      -- lightish blue background
local SYMBOL_BG = colors.lightGray  -- symbol background

-------------------------
-- PERIPHERALS
-------------------------
local monitor = peripheral.wrap("right")
local speaker = peripheral.wrap("top")
local dropper = peripheral.wrap("back")
if not monitor then error("No monitor on right") end
if not speaker then error("No speaker on top") end
if not dropper then error("No dropper on back") end

monitor.setBackgroundColor(MONITOR_BG)
monitor.clear()
if monitor.setTextScale then monitor.setTextScale(1) end

-------------------------
-- STATE VARIABLES
-------------------------
local jackpotCounter = 10
local spinning = false
local resultText,resultColor = nil,nil

-------------------------
-- HELPER FUNCTIONS
-------------------------
local function drawAt(x,y,text,color,bg)
    monitor.setCursorPos(x,y)
    monitor.setTextColor(color or colors.white)
    monitor.setBackgroundColor(bg or SYMBOL_BG)
    monitor.write(text)
end

local function clearMonitor()
    monitor.setBackgroundColor(MONITOR_BG)
    monitor.clear()
end

local function playSound(name,pitch) speaker.playSound(name,1,pitch) end
local function dispense(count) for i=1,count do dropper.drop(1) sleep(0.1) end end

local function flashResult(text,color,x,y)
    local flashes = 6
    local flashColors = {colors.white,color}
    for i=1,flashes do
        if spinning then return end
        drawAt(x,y,text,flashColors[(i%2)+1],SYMBOL_BG)
        sleep(0.3)
    end
    drawAt(x,y,text,color,SYMBOL_BG)
end

-------------------------
-- PAYOUT LOGIC
-------------------------
local function handleJackpot()
    resultText = "J"
    resultColor = colors.green
    dispense(jackpotCounter)
    jackpotCounter = 10
    playSound("entity.player.levelup",1.2)
end

local function handleTriple(symbol)
    local payout = PAYOUTS[symbol] or 1
    resultText = "WIN"
    resultColor = colors.green
    dispense(payout)
    jackpotCounter = math.min(jackpotCounter+1,JACKPOT_CAP)
    playSound("entity.player.levelup",1)
end

local function handlePity(symbol)
    local payout = PITY_PAYOUTS[symbol]
    if payout and payout>0 then
        resultText = "PITY"
        resultColor = colors.orange
        dispense(payout)
        jackpotCounter = math.min(jackpotCounter+1,JACKPOT_CAP)
        playSound("block.note_block.bell",1.2)
    else
        handleLose()
    end
end

local function handleLose()
    resultText = "LOSE"
    resultColor = colors.red
    jackpotCounter = math.min(jackpotCounter+1,JACKPOT_CAP)
    playSound("block.note_block.bass",0.8)
end

-------------------------
-- SPIN LOGIC (CENTERED GRID, COLORED SYMBOLS)
-------------------------
local function spin()
    spinning = true
    resultText,resultColor = nil,nil
    clearMonitor()

    local w,h = monitor.getSize()
    if h<5 then error("Monitor too short for 3 rows + result") end
    local middleRow = math.floor(h/2)

    -- Horizontal positions for 3 columns (centered)
    local symbolWidth = 1
    local totalWidth = 3*symbolWidth + 2
    local startX = math.floor((w-totalWidth)/2)+2
    local symbolX = {startX, startX+2, startX+4}

    local reels = {{" "," "," "},{" "," "," "},{" "," "," "}}

    -- Draw invisible grid first
    for row=1,3 do
        for col=1,3 do
            drawAt(symbolX[col], middleRow-2+row, " ", colors.white, SYMBOL_BG)
        end
    end

    -- Spin each column independently with staggered stop times
    for col=1,3 do
        local columnSpinTime = BASE_SPIN_TIME + SPIN_STAGGER*(col-1)
        local startTime = os.clock()
        while os.clock()-startTime < columnSpinTime do
            for row=1,3 do
                reels[col][row] = SYMBOLS[math.random(#SYMBOLS)]
                drawAt(symbolX[col], middleRow-2+row, reels[col][row], SYMBOL_COLORS[reels[col][row]], SYMBOL_BG)
            end
            playSound("block.note_block.hat",1)
            sleep(0.15)
        end
    end

    -- Final symbols for all columns
    for col=1,3 do
        for row=1,3 do
            reels[col][row] = SYMBOLS[math.random(#SYMBOLS)]
            drawAt(symbolX[col], middleRow-2+row, reels[col][row], SYMBOL_COLORS[reels[col][row]], SYMBOL_BG)
        end
    end

    -- Evaluate middle row of middle column
    local middleSymbol = reels[2][2]
    if middleSymbol=="N" then
        handleJackpot()
    else
        local chance = math.random(1,6)
        if chance==1 then
            handleTriple(middleSymbol)
        elseif chance==2 then
            handlePity(middleSymbol)
        else
            handleLose()
        end
    end

    -- Jackpot counter top-right
    drawAt(w-7,1,"J:"..jackpotCounter,colors.white,SYMBOL_BG)

    -- Flash result bottom row
    local resultY = h
    flashResult(resultText,resultColor,math.floor(w/2),resultY)

    spinning = false
end

-------------------------
-- MAIN LOOP
-------------------------
while true do
    os.pullEvent("redstone")
    if redstone.getInput("bottom") and not spinning then
        spin()
    end
end
