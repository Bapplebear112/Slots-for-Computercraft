-- SETTINGS -------------------------
local baseJackpot = 10
local jackpotCap = 128
local jackpotCounter = 0

-- Adjustable payout settings (normal wins only)
-- Jackpot is auto-calculated (baseJackpot + jackpotCounter)
local winPayouts = {
    G = 5,  -- Gold
    D = 4,  -- Diamond
    I = 3,  -- Iron
    B = 2,  -- Brick
    E = 1,  -- Emerald
    N = 0   -- Netherite = Jackpot only
}

local spinTime = 2       -- Seconds spinning
local spinSpeed = 0.1    -- Speed of spin animation
local symbolBgColor = colors.black
local bgColor = colors.gray
local textColor = colors.white
local jackpotColor = colors.lime
local winColor = colors.green
local loseColor = colors.red
local debugMode = false  -- True = print debug win rates
--------------------------------------

-- Symbols
local symbols = {
    {char="G", name="G"}, -- Gold
    {char="D", name="D"}, -- Diamond
    {char="I", name="I"}, -- Iron
    {char="B", name="B"}, -- Brick
    {char="E", name="E"}, -- Emerald
    {char="N", name="N"}, -- Netherite = Jackpot
}

-- Peripherals
local mon = peripheral.find("monitor")
mon.setTextScale(2)
mon.setBackgroundColor(bgColor)
mon.clear()

-- Jackpot display
local function displayJackpot()
    local w,h = mon.getSize()
    mon.setCursorPos(1,1)
    mon.setTextColor(colors.yellow)
    mon.write("Jackpot: "..jackpotCounter)
    mon.setTextColor(textColor)
end

-- Centered print
local function printCentered(y, text, color)
    local w,h = mon.getSize()
    local x = math.floor((w - #text) / 2) + 1
    mon.setCursorPos(x, y)
    mon.setTextColor(color or textColor)
    mon.write(text)
    mon.setTextColor(textColor)
end

-- Draw reels
local function drawReels(reels)
    local w,h = mon.getSize()
    local midY = math.floor(h/2)
    local totalWidth = #reels*2 - 1
    local startX = math.floor((w-totalWidth)/2)+1
    for i,s in ipairs(reels) do
        mon.setCursorPos(startX+(i-1)*2, midY)
        mon.setBackgroundColor(symbolBgColor)
        mon.write(symbols[s].char)
        mon.setBackgroundColor(bgColor)
    end
end

-- Flash bottom text
local function flashBottomText(text, color)
    local w,h = mon.getSize()
    local y = h
    for i=1,3 do
        printCentered(y, text, color)
        sleep(0.3)
        printCentered(y, string.rep(" ", #text), bgColor)
        sleep(0.3)
    end
    printCentered(y, text, color)
end

-- Check win
local function checkWin(reels)
    if reels[1]==reels[2] and reels[2]==reels[3] then
        local sym = symbols[reels[1]].name
        if sym=="N" then return "jackpot", sym end
        return "win", sym
    end
    return "lose"
end

-- Payout calculation
local function calculatePayout(result, winningSymbol)
    if result=="jackpot" then
        return baseJackpot + jackpotCounter
    elseif result=="win" then
        return winPayouts[winningSymbol] or 1
    else
        return 0
    end
end

-- Dispense
local function dispenseItems(amount)
    local disp = peripheral.find("dropper") or peripheral.find("dispenser")
    if not disp then return end
    for i=1,amount do
        disp.drop(1) -- one item
        sleep(0.2)   -- wait to prevent overlap
    end
end

-- Spin
local function spin()
    jackpotCounter = math.min(jackpotCounter + 1, jackpotCap)

    -- Spin animation
    local finalReels = {}
    for i=1,3 do
        finalReels[i] = math.random(#symbols)
    end

    local t0 = os.clock()
    while os.clock()-t0 < spinTime do
        local reels = {}
        for i=1,3 do
            reels[i] = math.random(#symbols)
        end
        mon.clear()
        displayJackpot()
        drawReels(reels)
        sleep(spinSpeed)
    end

    -- Final reels
    mon.clear()
    displayJackpot()
    drawReels(finalReels)

    -- Win check
    local result, sym = checkWin(finalReels)
    local payout = calculatePayout(result, sym)
    if payout>0 then
        dispenseItems(payout)
    end
    if result=="jackpot" then
        jackpotCounter = 0
    end
    displayJackpot()

    -- Show flashing result
    if result=="jackpot" then
        flashBottomText("JACKPOT!", jackpotColor)
    elseif result=="win" then
        flashBottomText("WIN!", winColor)
    else
        flashBottomText("LOSE!", loseColor)
    end

    if debugMode then
        print("Result:", result, "Symbol:", sym, "Payout:", payout, "Jackpot:", jackpotCounter)
    end
end

-- MAIN LOOP
print("Slot machine running...")
while true do
    local e, side = os.pullEvent()
    if e=="redstone" then
        if rs.getInput("back") then  -- adjust side
            spin()
        end
    end
end
