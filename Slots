-------------------------
-- SLOT MACHINE SETTINGS
-------------------------
local SYMBOLS = {"I","B","E","D","G","N"} -- slot symbols
local SPIN_TIME = 1.5
local JACKPOT_CAP = 128
local PAYOUTS = {I=2,B=3,E=4,D=5,G=6}
local PITY_PAYOUTS = {I=0,B=0,E=0,D=0,G=0,N=1}

local MONITOR_BG = colors.gray        -- monitor background
local SYMBOL_BG = colors.lightGray    -- symbol background

-------------------------
-- PERIPHERALS
-------------------------
local monitor = peripheral.wrap("right")
local speaker = peripheral.wrap("top")
local dropper = peripheral.wrap("back")
if not monitor then error("No monitor on right") end
if not speaker then error("No speaker on top") end
if not dropper then error("No dropper on back") end

monitor.setBackgroundColor(MONITOR_BG)
monitor.clear()
if monitor.setTextScale then monitor.setTextScale(1) end

-------------------------
-- STATE VARIABLES
-------------------------
local jackpotCounter = 10
local spinning = false
local resultText,resultColor = nil,nil

-------------------------
-- HELPER FUNCTIONS
-------------------------
local function drawAt(x,y,text,color,bg)
    monitor.setCursorPos(x,y)
    monitor.setTextColor(color or colors.white)
    monitor.setBackgroundColor(bg or SYMBOL_BG)
    monitor.write(text)
end

local function clearMonitor()
    monitor.setBackgroundColor(MONITOR_BG)
    monitor.clear()
end

local function playSound(name,pitch) speaker.playSound(name,1,pitch) end
local function dispense(count) for i=1,count do dropper.drop(1) sleep(0.1) end end

local function flashResult(text,color,x,y)
    local flashes = 6
    local flashColors = {colors.white,color}
    for i=1,flashes do
        if spinning then return end
        drawAt(x,y,text,flashColors[(i%2)+1],SYMBOL_BG)
        sleep(0.3)
    end
    drawAt(x,y,text,color,SYMBOL_BG)
end

-------------------------
-- PAYOUT LOGIC
-------------------------
local function handleJackpot()
    resultText = "J"
    resultColor = colors.green
    dispense(jackpotCounter)
    jackpotCounter = 10
    playSound("entity.player.levelup",1.2)
end

local function handleTriple(symbol)
    local payout = PAYOUTS[symbol] or 1
    resultText = "WIN"
    resultColor = colors.green
    dispense(payout)
    jackpotCounter = math.min(jackpotCounter+1,JACKPOT_CAP)
    playSound("entity.player.levelup",1)
end

local function handlePity(symbol)
    local payout = PITY_PAYOUTS[symbol]
    if payout and payout>0 then
        resultText = "PITY"
        resultColor = colors.orange
        dispense(payout)
        jackpotCounter = math.min(jackpotCounter+1,JACKPOT_CAP)
        playSound("block.note_block.bell",1.2)
    else
        handleLose()
    end
end

local function handleLose()
    resultText = "LOSE"
    resultColor = colors.red
    jackpotCounter = math.min(jackpotCounter+1,JACKPOT_CAP)
    playSound("block.note_block.bass",0.8)
end

-------------------------
-- SPIN LOGIC
-------------------------
local function spin()
    spinning = true
    resultText,resultColor = nil,nil
    clearMonitor()

    local w,h = monitor.getSize()
    local middleY = math.floor(h/2)
    
    -- Calculate X positions for 3 symbols centered
    local symbolWidth = 1
    local totalWidth = 3*symbolWidth + 2 -- 2 spaces between symbols
    local startX = math.floor((w-totalWidth)/2)+1
    local symbolX = {startX, startX+2, startX+4}

    local startTime = os.clock()
    local reels = {" "," "," "}

    -- Spin animation
    while os.clock()-startTime < SPIN_TIME do
        for i=1,3 do
            reels[i] = SYMBOLS[math.random(#SYMBOLS)]
            drawAt(symbolX[i],middleY,reels[i],colors.yellow,SYMBOL_BG)
        end
        drawAt(symbolX[2],middleY-1,"v",colors.red,SYMBOL_BG) -- arrow above middle
        playSound("block.note_block.hat",1)
        sleep(0.2)
    end

    -- Final symbols
    for i=1,3 do
        reels[i] = SYMBOLS[math.random(#SYMBOLS)]
        drawAt(symbolX[i],middleY,reels[i],colors.yellow,SYMBOL_BG)
    end
    drawAt(symbolX[2],middleY-1,"v",colors.red,SYMBOL_BG)

    -- Evaluate middle symbol
    local middleSymbol = reels[2]
    if middleSymbol=="N" then
        handleJackpot()
    else
        local chance = math.random(1,6)
        if chance==1 then
            handleTriple(middleSymbol)
        elseif chance==2 then
            handlePity(middleSymbol)
        else
            handleLose()
        end
    end

    -- Jackpot counter top-right
    drawAt(w-7,1,"JP:"..jackpotCounter,colors.white,SYMBOL_BG)

    -- Flash result below symbols
    local resultY = middleY+1
    flashResult(resultText,resultColor,symbolX[2],resultY)

    spinning = false
end

-------------------------
-- MAIN LOOP
-------------------------
while true do
    os.pullEvent("redstone")
    if redstone.getInput("bottom") and not spinning then
        spin()
    end
end
